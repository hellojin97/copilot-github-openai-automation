name: Issue Classifier

on:
  issues:
    types: [opened, edited]

jobs:
  classify_issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm init -y
          npm install axios

      - name: Classify Issue with Azure OpenAI
        id: classify
        uses: actions/github-script@v7
        with:
          script: |
            const axios = require('axios');
            
            // Azure OpenAI API ì„¤ì •
            const AZURE_ENDPOINT = 'https://eduin4ucpopenaikrc.openai.azure.com/openai/deployments/gpt-4o-mini/chat/completions?api-version=2025-01-01-preview';
            const API_KEY = '${{ secrets.AZURE_OPENAI_API_KEY }}';
            
            // ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const issue = context.payload.issue;
            const issueTitle = issue.title;
            const issueBody = issue.body || '';
            const issueNumber = issue.number;
            
            console.log(`Processing issue #${issueNumber}: ${issueTitle}`);
            
            // OpenAI API í˜¸ì¶œì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ ìƒì„±
            const prompt = `
            ë‹¤ìŒ GitHub ì´ìŠˆë¥¼ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ë¼ë²¨ì„ ì œì•ˆí•˜ê³ , ì‚¬ìš©ìì—ê²Œ ë„ì›€ì´ ë  ë§Œí•œ ì•ˆë‚´ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

            ì´ìŠˆ ì œëª©: ${issueTitle}
            ì´ìŠˆ ë‚´ìš©: ${issueBody}

            ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ ì¤‘ì—ì„œ ê°€ì¥ ì ì ˆí•œ ë¼ë²¨ë“¤ì„ ì„ íƒí•˜ê³ , ê·¸ ì´ìœ ì™€ í•¨ê»˜ ì‚¬ìš©ìì—ê²Œ ë„ì›€ì´ ë  ì•ˆë‚´ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

            ì‚¬ìš© ê°€ëŠ¥í•œ ë¼ë²¨:
            - bug: ë²„ê·¸ ë¦¬í¬íŠ¸
            - feature: ìƒˆë¡œìš´ ê¸°ëŠ¥ ìš”ì²­
            - enhancement: ê¸°ì¡´ ê¸°ëŠ¥ ê°œì„ 
            - documentation: ë¬¸ì„œ ê´€ë ¨
            - question: ì§ˆë¬¸
            - help wanted: ë„ì›€ì´ í•„ìš”í•œ ì´ìŠˆ
            - good first issue: ì´ˆë³´ìì—ê²Œ ì í•©í•œ ì´ìŠˆ
            - priority-high: ë†’ì€ ìš°ì„ ìˆœìœ„
            - priority-medium: ì¤‘ê°„ ìš°ì„ ìˆœìœ„
            - priority-low: ë‚®ì€ ìš°ì„ ìˆœìœ„

            ì‘ë‹µ í˜•ì‹ (JSON):
            {
              "labels": ["label1", "label2"],
              "comment": "ì‚¬ìš©ìì—ê²Œ ë„ì›€ì´ ë  ì¹œê·¼í•˜ê³  êµ¬ì²´ì ì¸ ì•ˆë‚´ ì½”ë©˜íŠ¸"
            }
            `;

            try {
              // Azure OpenAI API í˜¸ì¶œ
              const response = await axios.post(AZURE_ENDPOINT, {
                messages: [
                  {
                    role: "system",
                    content: "ë‹¹ì‹ ì€ GitHub ì´ìŠˆë¥¼ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ë¼ë²¨ì„ ë¶„ë¥˜í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì¹œê·¼í•˜ê³  ë„ì›€ì´ ë˜ëŠ” ë‹µë³€ì„ ì œê³µí•´ì£¼ì„¸ìš”."
                  },
                  {
                    role: "user",
                    content: prompt
                  }
                ],
                max_tokens: 500,
                temperature: 0.3
              }, {
                headers: {
                  'Content-Type': 'application/json',
                  'api-key': API_KEY
                }
              });

              const aiResponse = response.data.choices[0].message.content;
              console.log('AI Response:', aiResponse);
              
              // JSON ì‘ë‹µ íŒŒì‹±
              let result;
              try {
                // JSON ë¸”ë¡ì—ì„œ ì‹¤ì œ JSON ì¶”ì¶œ
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                  result = JSON.parse(jsonMatch[0]);
                } else {
                  throw new Error('JSON format not found');
                }
              } catch (parseError) {
                console.log('JSON parsing failed, using fallback');
                result = {
                  labels: ['question'],
                  comment: 'ì´ìŠˆë¥¼ ê²€í† í–ˆìŠµë‹ˆë‹¤. ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•˜ë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš”! ğŸ˜Š'
                };
              }

              // ë¼ë²¨ ì¶”ê°€
              if (result.labels && result.labels.length > 0) {
                console.log('Adding labels:', result.labels);
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: result.labels
                });
              }

              // ì½”ë©˜íŠ¸ ì¶”ê°€
              if (result.comment) {
                console.log('Adding comment');
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `ğŸ¤– **AI ì´ìŠˆ ë¶„ì„ ê²°ê³¼**\n\n${result.comment}\n\n---\n*ì´ ì½”ë©˜íŠ¸ëŠ” AIì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`
                });
              }

              return result;

            } catch (error) {
              console.error('Error calling Azure OpenAI API:', error.response?.data || error.message);
              
              // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ ë¼ë²¨ê³¼ ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['needs-triage']
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ğŸ¤– ì•ˆë…•í•˜ì„¸ìš”! ì´ìŠˆë¥¼ ë“±ë¡í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n\ní˜„ì¬ AI ë¶„ì„ ì‹œìŠ¤í…œì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ìˆì–´ ìë™ ë¶„ë¥˜ê°€ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ ê³§ í™•ì¸í•˜ì—¬ ì ì ˆí•œ ë¼ë²¨ì„ ë¶™ì—¬ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.\n\nê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ëŒ“ê¸€ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”! ğŸ˜Š\n\n---\n*ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`
              });

              throw error;
            }

      - name: Log Classification Result
        if: success()
        run: |
          echo "Issue classification completed successfully"
          echo "Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}"